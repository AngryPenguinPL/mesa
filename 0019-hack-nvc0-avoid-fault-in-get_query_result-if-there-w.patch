From f27460c54c9e607052b1972c0ec85a742b305579 Mon Sep 17 00:00:00 2001
From: Christoph Bumiller <christoph.bumiller@speed.at>
Date: Sun, 26 May 2013 12:55:38 +0200
Subject: [PATCH 19/34] hack/nvc0: avoid fault in get_query_result if there was
 no begin_query

---
 src/gallium/drivers/nouveau/nvc0/nvc0_query.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/gallium/drivers/nouveau/nvc0/nvc0_query.c b/src/gallium/drivers/nouveau/nvc0/nvc0_query.c
index 3a6df9d..8862257 100644
--- a/src/gallium/drivers/nouveau/nvc0/nvc0_query.c
+++ b/src/gallium/drivers/nouveau/nvc0/nvc0_query.c
@@ -439,6 +439,10 @@ nvc0_query_result(struct pipe_context *pipe, struct pipe_query *pq,
    uint64_t *data64 = (uint64_t *)q->data;
    unsigned i;
 
+   if ((int32_t)q->offset < (int32_t)q->base)
+      return FALSE; /* query never been issued */
+   /* XXX: get rid of the rotation hack */
+
 #ifdef NOUVEAU_ENABLE_DRIVER_STATISTICS
    if (q->type >= NVC0_QUERY_DRV_STAT(0) &&
        q->type <= NVC0_QUERY_DRV_STAT_LAST) {
-- 
2.1.3

