From b3f1b01e4e5cae30b5b951e158cef4c7c38b5f51 Mon Sep 17 00:00:00 2001
From: Christoph Bumiller <e0425955@student.tuwien.ac.at>
Date: Wed, 22 May 2013 22:19:05 +0200
Subject: [PATCH 16/34] nv50,nvc0: handle NULL vertex elements without fallback

This makes Gallium Nine faster.
---
 src/gallium/drivers/nouveau/nv50/nv50_vbo.c | 14 +++++++++-----
 src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c | 11 ++++++++---
 2 files changed, 17 insertions(+), 8 deletions(-)

diff --git a/src/gallium/drivers/nouveau/nv50/nv50_vbo.c b/src/gallium/drivers/nouveau/nv50/nv50_vbo.c
index 5a4a457..d15975d 100644
--- a/src/gallium/drivers/nouveau/nv50/nv50_vbo.c
+++ b/src/gallium/drivers/nouveau/nv50/nv50_vbo.c
@@ -31,6 +31,11 @@
 
 #include "nv50/nv50_3d.xml.h"
 
+#define NV50_3D_VERTEX_ATTRIB_INACTIVE              \
+   NV50_3D_VERTEX_ARRAY_ATTRIB_TYPE_FLOAT |         \
+   NV50_3D_VERTEX_ARRAY_ATTRIB_FORMAT_32_32_32_32 | \
+   NV50_3D_VERTEX_ARRAY_ATTRIB_CONST
+
 void
 nv50_vertex_state_delete(struct pipe_context *pipe,
                          void *hwcso)
@@ -78,6 +83,10 @@ nv50_vertex_state_create(struct pipe_context *pipe,
         so->element[i].state = nv50_format_table[fmt].vtx;
 
         if (!so->element[i].state) {
+            if (fmt == PIPE_FORMAT_NONE) {
+               so->element[i].state = NV50_3D_VERTEX_ATTRIB_INACTIVE;
+               continue;
+            }
             switch (util_format_get_nr_components(fmt)) {
             case 1: fmt = PIPE_FORMAT_R32_FLOAT; break;
             case 2: fmt = PIPE_FORMAT_R32G32_FLOAT; break;
@@ -127,11 +136,6 @@ nv50_vertex_state_create(struct pipe_context *pipe,
     return so;
 }
 
-#define NV50_3D_VERTEX_ATTRIB_INACTIVE              \
-   NV50_3D_VERTEX_ARRAY_ATTRIB_TYPE_FLOAT |         \
-   NV50_3D_VERTEX_ARRAY_ATTRIB_FORMAT_32_32_32_32 | \
-   NV50_3D_VERTEX_ARRAY_ATTRIB_CONST
-
 static void
 nv50_emit_vtxattr(struct nv50_context *nv50, struct pipe_vertex_buffer *vb,
                   struct pipe_vertex_element *ve, unsigned attr)
diff --git a/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c b/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
index f99d533..0911eb2 100644
--- a/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
+++ b/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
@@ -33,6 +33,10 @@
 
 #include "nvc0/nvc0_3d.xml.h"
 
+#define NVC0_3D_VERTEX_ATTRIB_INACTIVE                                       \
+   NVC0_3D_VERTEX_ATTRIB_FORMAT_TYPE_FLOAT |                                 \
+   NVC0_3D_VERTEX_ATTRIB_FORMAT_SIZE_32 | NVC0_3D_VERTEX_ATTRIB_FORMAT_CONST
+
 void
 nvc0_vertex_state_delete(struct pipe_context *pipe,
                          void *hwcso)
@@ -82,6 +86,10 @@ nvc0_vertex_state_create(struct pipe_context *pipe,
         so->element[i].state = nvc0_format_table[fmt].vtx;
 
         if (!so->element[i].state) {
+            if (fmt == PIPE_FORMAT_NONE) {
+               so->element[i].state = NVC0_3D_VERTEX_ATTRIB_INACTIVE;
+               continue;
+            }
             switch (util_format_get_nr_components(fmt)) {
             case 1: fmt = PIPE_FORMAT_R32_FLOAT; break;
             case 2: fmt = PIPE_FORMAT_R32G32_FLOAT; break;
@@ -153,9 +161,6 @@ nvc0_vertex_state_create(struct pipe_context *pipe,
     return so;
 }
 
-#define NVC0_3D_VERTEX_ATTRIB_INACTIVE                                       \
-   NVC0_3D_VERTEX_ATTRIB_FORMAT_TYPE_FLOAT |                                 \
-   NVC0_3D_VERTEX_ATTRIB_FORMAT_SIZE_32 | NVC0_3D_VERTEX_ATTRIB_FORMAT_CONST
 
 #define VTX_ATTR(a, c, t, s)                            \
    ((NVC0_3D_VTX_ATTR_DEFINE_TYPE_##t) |                \
-- 
2.1.3

