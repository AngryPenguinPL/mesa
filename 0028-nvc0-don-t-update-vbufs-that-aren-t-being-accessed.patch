From b6d357da8f07079626e183571d323886c62395f4 Mon Sep 17 00:00:00 2001
From: Christoph Bumiller <christoph.bumiller@speed.at>
Date: Mon, 17 Jun 2013 13:31:17 +0200
Subject: [PATCH 28/34] nvc0: don't update vbufs that aren't being accessed

---
 src/gallium/drivers/nouveau/nvc0/nvc0_stateobj.h |  1 +
 src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c      | 10 +++++++---
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/src/gallium/drivers/nouveau/nvc0/nvc0_stateobj.h b/src/gallium/drivers/nouveau/nvc0/nvc0_stateobj.h
index 3382933..5352184 100644
--- a/src/gallium/drivers/nouveau/nvc0/nvc0_stateobj.h
+++ b/src/gallium/drivers/nouveau/nvc0/nvc0_stateobj.h
@@ -56,6 +56,7 @@ struct nvc0_vertex_stateobj {
    unsigned num_elements;
    uint32_t instance_elts;
    uint32_t instance_bufs;
+   uint32_t accessed_bufs;
    boolean shared_slots;
    boolean need_conversion; /* e.g. VFETCH cannot convert f64 to f32 */
    unsigned size; /* size of vertex in bytes (when packed) */
diff --git a/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c b/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
index eeaf5ce..18a6c2d 100644
--- a/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
+++ b/src/gallium/drivers/nouveau/nvc0/nvc0_vbo.c
@@ -110,6 +110,8 @@ nvc0_vertex_state_create(struct pipe_context *pipe,
         if (so->vb_access_size[vbi] < (ve->src_offset + size))
            so->vb_access_size[vbi] = ve->src_offset + size;
 
+        so->accessed_bufs |= 1 << vbi;
+
         if (unlikely(ve->instance_divisor)) {
            so->instance_elts |= 1 << i;
            so->instance_bufs |= 1 << vbi;
@@ -381,7 +383,7 @@ nvc0_validate_vertex_buffers_shared(struct nvc0_context *nvc0)
 {
    struct nouveau_pushbuf *push = nvc0->base.pushbuf;
    unsigned b;
-   const uint32_t mask = nvc0->vbo_user;
+   const uint32_t mask = nvc0->vbo_user | ~nvc0->vertex->accessed_bufs;
 
    PUSH_SPACE(push, nvc0->num_vtxbufs * 8);
    for (b = 0; b < nvc0->num_vtxbufs; ++b) {
@@ -390,11 +392,13 @@ nvc0_validate_vertex_buffers_shared(struct nvc0_context *nvc0)
       uint32_t offset, limit;
 
       if (mask & (1 << b)) {
-         if (!(nvc0->constant_vbos & (1 << b))) {
+         /* user buffer or not accessed */
+         if (!(nvc0->constant_vbos & (1 << b)) &&
+	     nvc0->vertex->accessed_bufs & (1 << b)) {
             BEGIN_NVC0(push, NVC0_3D(VERTEX_ARRAY_FETCH(b)), 1);
             PUSH_DATA (push, NVC0_3D_VERTEX_ARRAY_FETCH_ENABLE | vb->stride);
+            /* address/value set in nvc0_update_user_vbufs_shared */
          }
-         /* address/value set in nvc0_update_user_vbufs_shared */
          continue;
       }
       if (!vb->buffer) {
-- 
2.1.3

